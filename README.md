# Практическое задание 1. Параллельная реализация операций с сеточными данными на неструктурированной смешанной сетке 

Первое задание по курсу "параллельные вычисления" на ВМК МГУ в 2020.
### Вариант B2

## Сборка
Сборка осуществляется с помощью make файла, так что достаточно выполнить в терминале команду `make main`. При этом на Вашей системе должен быть установлен компилятор языка C++.

## Запуск
Приложение использует обработку аргументов командной строки. Для работы допускается два варианта запуска: `./main path [debug]` и `./main Nx Ny k1 k2 eps T [debug]`
В первом случае аргументы Nx, Ny, k1, k2, eps и T будут считаны из файла, находящегося по пути `path`.

### Аргументы
`path` - путь к файлу с аргументами. Ожидается, что в файле записаны 6 чисел: Nx, Ny, k1, k2, eps, T

`Nx` - количество ячеек сетки по горизонтали

`Ny` - количество ячеек сетки по вертикали

`k1` - количество прямоугольных ячеек сетки

`k2` - количество треугольных ячеек сетки

`eps` - относительная точность решения

`T` - количество потоков

`debug` - использование отладочной информации (`y` - полная отладка, `s` - вывод значений невязки на итерациях солвера, `n` - без отладки)

## Производительность
Система: Ubuntu 18, CPU: Intel Core I7-8700 3.2GHz, 6 cores
Параметры сетки: k1 = 29, k2 = 37

### Nx = 500, Ny = 500
|  T  | Generation time, ms | Fill time, ms | Solve time, ms |
| --- |                 :-: |           :-: |            :-: |
|   1 |                   9 |          45.8 |          159.2 |
|   2 |                 5.2 |            23 |             97 |
|   4 |                   3 |            12 |           81.2 |
|   8 |                   2 |             8 |             80 |
|  16 |                 2.2 |             8 |             90 |

### Nx = 1000, Ny = 1000
|  T  | Generation time, ms | Fill time, ms | Solve time, ms |
| --- |                 :-: |           :-: |            :-: |
|   1 |                35.6 |         183.8 |          839.2 |
|   2 |                20.6 |          93.6 |          571.8 |
|   4 |                11.8 |          48.4 |          530.6 |
|   8 |                 9.6 |          33.6 |          553.4 |
|  16 |                 9.2 |          30.2 |          584.6 |

### Nx = 2000, Ny = 2000
|  T  | Generation time, ms | Fill time, ms | Solve time, ms |
| --- |                 :-: |           :-: |            :-: |
|   1 |                 168 |         741.8 |           3266 |
|   2 |                91.2 |           379 |           2311 |
|   4 |                  53 |           198 |         2178.8 |
|   8 |                  42 |           135 |         2199.8 |
|  16 |                41.2 |           103 |           2255 |

### Nx = 4000, Ny = 4000
|  T  | Generation time, ms | Fill time, ms | Solve time, ms |
| --- |                 :-: |           :-: |            :-: |
|   1 |               688.4 |        2970.2 |        14145.6 |
|   2 |               388.4 |        1530.8 |        10103.2 |
|   4 |               231.2 |         793.8 |         9486.2 |
|   8 |               188.4 |         522.2 |         9587.8 |
|  16 |               169.8 |         409.4 |           9828 |

## Производительность математических ядер
N = 1000
|  T  | Dot, ms | Linear combination, ms | Matrix-vector mult, ms |
| --- |     :-: |                    :-: |                    :-: |
|  1  |  0.0014 |                 0.0022 |                  0.947 |
|  2  |  0.0013 |                 0.0021 |                  0.485 |
|  4  |  0.0013 |                 0.0019 |                  0.251 |
|  8  |  0.0012 |                 0.0013 |                  0.134 |
| 16  |  0.0292 |                 0.0287 |                  0.183 |

N = 10000
|  T  | Dot, ms | Linear combination, ms |
| --- |     :-: |                    :-: |
|  1  |  0.0092 |                 0.0033 |
|  2  |  0.0054 |                 0.0022 |
|  4  |  0.0032 |                 0.0016 |
|  8  |  0.0022 |                 0.0015 |
| 16  |  0.0327 |                 0.0287 |

N = 100000
|  T  | Dot, ms | Linear combination, ms |
| --- |     :-: |                    :-: |
|  1  |   0.088 |                 0.0313 |
|  2  |   0.046 |                 0.0176 |
|  4  |   0.024 |                 0.0095 |
|  8  |   0.013 |                 0.0083 |
| 16  |   0.046 |                 0.0371 |

## Примеры запуска
```bash
>./main 4 4 1 2 1e-5 32 y
+--------------------------------------+
|             Generate part            |
+--------------------+-----------------+
|           Vertices |              26 |
|              Edges |              94 |
| Portrait non zeros |              91 |
|   Elapsed time, ms |               0 |
+--------------------+-----------------+

+--------------------------------------+
|               Fill part              |
+--------------------+-----------------+
|   Elapsed time, ms |               0 |
+--------------------+-----------------+

+--------------------------------------+
|              Solve part              |
+--------------------+-----------------+
|   Elapsed time, ms |               0 |
|           |b - Ax| |      0.00215439 |
|         Iterations |              23 |
+--------------------+-----------------+
```

### То же самое, но с отладочной информацией
```bash
./main 4 4 1 2 1e-5 32 y
Parsed arguments:
Nx: 4
Ny: 4
k1: 1
k2: 2
eps: 1e-05
T: 1

Rectangles count: 6
Triangles count: 20
Vertices count: 26
Edges count: 94

Edges list:
0 -> [ 0 1 7 ]
1 -> [ 0 1 2 9 ]
2 -> [ 1 2 3 ]
3 -> [ 2 3 4 10 ]
4 -> [ 3 4 5 ]
5 -> [ 4 5 12 ]
6 -> [ 6 7 14 ]
7 -> [ 0 6 7 8 ]
8 -> [ 7 8 9 15 ]
9 -> [ 1 8 9 10 ]
10 -> [ 3 9 10 11 17 ]
11 -> [ 10 11 12 19 ]
12 -> [ 5 11 12 ]
13 -> [ 13 14 20 ]
14 -> [ 6 13 14 15 ]
15 -> [ 8 14 15 16 22 ]
16 -> [ 15 16 17 24 ]
17 -> [ 10 16 17 18 ]
18 -> [ 17 18 19 25 ]
19 -> [ 11 18 19 ]
20 -> [ 13 20 21 ]
21 -> [ 20 21 22 ]
22 -> [ 15 21 22 23 ]
23 -> [ 22 23 24 ]
24 -> [ 16 23 24 25 ]
25 -> [ 18 24 25 ]
N: 26
IA: [ 0 3 7 10 14 17 20 23 27 31 35 40 44 47 50 54 59 63 67 71 74 77 80 84 87 91 94 ]
JA: [ 0 1 7 0 1 2 9 1 2 3 2 3 4 10 3 4 5 4 5 12 6 7 14 0 6 7 8 7 8 9 15 1 8 9 10 3 9 10 11 17 10 11 12 19 5 11 12 13 14 20 6 13 14 15 8 14 15 16 22 15 16 17 24 10 16 17 18 17 18 19 25 11 18 19 13 20 21 20 21 22 15 21 22 23 22 23 24 16 23 24 25 18 24 25 ]
+--------------------------------------+
|             Generate part            |
+--------------------+-----------------+
|           Vertices |              26 |
|              Edges |              94 |
| Portrait non zeros |              91 |
|   Elapsed time, ms |               0 |
+--------------------+-----------------+

v: A b
0: 1.2942       0.540302     0.283662      = 0
1: 1.2942       0.540302     0.753902     0.0044257     = 0.841471
2: 0.540302     0.753902     0.540302      = 0.909297
3: 0.753902     0.540302     1.81267      0.0044257     = 0.14112
4: 0.540302     1.81267      0.283662      = -0.756802
5: 1.81267      0.283662     0.988705      = -0.958924
6: 0.988705     0.283662     0.988705      = -0.279415
7: 1.2942       0.988705     0.283662     0.288088      = 0.656987
8: 0.283662     0.288088     0.0044257    1.73676       = 0.989358
9: 0.540302     0.288088     0.0044257    0.0044257     = 0.412118
10: 0.540302     0.0044257    0.0044257    1.54824      -0.748058     = -0.544021
11: 0.0044257    1.54824      0.988705     -0.030975     = -0.99999
12: 0.283662     1.54824      0.988705      = -0.536573
13: 0.555113     0.988705     0.968995      = 0.420167
14: 0.988705     0.555113     0.988705     1.73676       = 0.990607
15: 0.288088     0.988705     1.73676      -0.748058    -0.946868     = 0.650288
16: 1.73676      -0.748058    -0.748058    0.0221268     = -0.287903
17: 0.0044257    -0.748058    -0.748058    0.779033      = -0.961397
18: -0.748058    0.779033     -0.030975    1.08505       = -0.750987
19: 1.54824      0.779033     -0.030975     = 0.149877
20: 0.555113     0.968995     0.0221268     = 0.912945
21: 0.968995     0.0221268    -0.946868     = 0.836656
22: 1.73676      0.0221268    -0.946868    0.753902      = -0.00885131
23: -0.946868    0.753902     0.0221268     = -0.84622
24: -0.748058    0.753902     0.0221268    1.08505       = -0.905578
25: 0.779033     0.0221268    1.08505       = -0.132352
+--------------------------------------+
|               Fill part              |
+--------------------+-----------------+
|   Elapsed time, ms | 0               |
+--------------------+-----------------+

Iteration 1, |b - Ax|: 3.54272, rho: 11.9252
Iteration 2, |b - Ax|: 3.64587, rho: 8.13757
Iteration 3, |b - Ax|: 2.57296, rho: 4.91272
Iteration 4, |b - Ax|: 2.1353, rho: 2.87278
Iteration 5, |b - Ax|: 2.27338, rho: 3.02943
Iteration 6, |b - Ax|: 2.30135, rho: 3.67445
Iteration 7, |b - Ax|: 1.73054, rho: 2.3192
Iteration 8, |b - Ax|: 1.27477, rho: 1.27084
Iteration 9, |b - Ax|: 1.40154, rho: 1.5219
Iteration 10, |b - Ax|: 1.42666, rho: 1.36751
Iteration 11, |b - Ax|: 1.0942, rho: 0.757648
Iteration 12, |b - Ax|: 0.615341, rho: 0.211599
Iteration 13, |b - Ax|: 0.343309, rho: 0.0707409
Iteration 14, |b - Ax|: 0.237946, rho: 0.0378749
Iteration 15, |b - Ax|: 0.219492, rho: 0.026921
Iteration 16, |b - Ax|: 0.166017, rho: 0.0155849
Iteration 17, |b - Ax|: 0.0924228, rho: 0.00643842
Iteration 18, |b - Ax|: 0.0417177, rho: 0.00121485
Iteration 19, |b - Ax|: 0.0279739, rho: 0.000500765
Iteration 20, |b - Ax|: 0.0227914, rho: 0.000404203
Iteration 21, |b - Ax|: 0.009535, rho: 6.70745e-05
Iteration 22, |b - Ax|: 0.00495491, rho: 1.69704e-05
Iteration 23, |b - Ax|: 0.00335537, rho: 8.06896e-06
x: [ -9.69817 9.09318 -5.96146 10.742 -11.9758 -12.5942 -2.49031 10.1325 9.61521 -8.81002 -8.3272 5.56462 3.44375 5.49452 -2.01619 3.22228 -5.86714 -7.42062 -7.33762 -5.99622 5.80692 4.78422 2.58445 -3.45041 -5.87828 -7.13931 ]

+--------------------------------------+
|              Solve part              |
+--------------------+-----------------+
|   Elapsed time, ms |               0 |
|           |b - Ax| |      0.00215439 |
|         Iterations |              23 |
+--------------------+-----------------+
```

## Тесты
Для сборки самопроверки выполните команду `make tests && ./tests`. Если всё корректно, в консоли должен быть следующий вывод
```bash
>make tests && ./tests
Generator test for (1x1 for k = 0 and 1): OK
Generator test for (2x1 for k = 1 and 0): OK
Generator test for (2x1 for k = 1 and 1): OK
Generator test for (3x2 for k = 1 and 2): OK
Generator test for (5x2 for k = 2 and 1): OK
Generator test for (4x3 for k = 3 and 2): OK
Generator test for (3x4 for k = 1 and 0): OK
Generator test for (3x4 for k = 0 and 1): OK
Generator test for (7x5 for k = 11 and 13): OK

Fill test for n = 3: OK
Fill test for n = 5: OK
Fill test for n = 27: OK

Dot test for n = 3: OK
Dot test for n = 1: OK
Dot test for n = 2: OK
Dot test for n = 5: OK
Dot test for n = 10: OK

Linear combination test for n = 3 and a = 2, b = -3: OK
Linear combination test for n = 10 and a = -5, b = 0.5: OK

Test matrix to vector multiplication for n = 3: OK
Test matrix to vector multiplication for n = 5: OK
```

## Визуализатор
Для того, чтобы результат работы генератора был более наглядным, имеется html визуализатор. Визуализатор позволяет задавать входные аргументы и отображает сетку и полученные рёбра на ней.
Визуализатор доступен по адресу: <a href="https://programforyou.ru/tests/parallel-visualizer">programforyou.ru/tests/parallel-visualizer</a>

<img src='https://github.com/dronperminov/ParallelProgrammingTask1/blob/master/examples/visualizer.png' />

## Примеры сеток (результат работы визуализатора)

<table>
  <tr>
    <td width='50%'><img src='https://github.com/dronperminov/ParallelProgrammingTask1/blob/master/examples/example1.png' /></td>
    <td width='50%'><img src='https://github.com/dronperminov/ParallelProgrammingTask1/blob/master/examples/example2.png' /></td>
  </tr>
  
  <tr>
    <td width='50%'><img src='https://github.com/dronperminov/ParallelProgrammingTask1/blob/master/examples/example3.png' /></td>
    <td width='50%'><img src='https://github.com/dronperminov/ParallelProgrammingTask1/blob/master/examples/example4.png' /></td>
  </tr>
</table>